# Пайплайн детекции «Негерметичности НКТ»

Документ описывает текущий процесс работы с рабочей книгой `alma/Общая_таблица.xlsx`, пересчёта детектора и подготовки референсных отчётов.

## 0. Устройство кода

Основная логика детектора разбита на пакет `src/pipeline/anomalies/`:
- `__init__.py` оркестрирует запуск и экспортирует публичные функции;
- `models.py` описывает dataclass-структуры интервалов, настроек и baseline;
- `settings.py` читает конфигурацию (`detection`, `detection_residual` и т.д.);
- `preprocessing.py` занимается загрузкой Excel и очисткой сигналов (Hampel, ffill);
- `detection.py` отвечает за построение baseline, вычисление признаков и поиск сегментов.

При доработках держим эти границы ответственности, чтобы модуль оставался расширяемым.

## 1. Конфигурация

Файл `config/pipeline.yaml` содержит:
- директорию для отчётов (`paths.reports_dir`);
- настройки блока `anomalies`:
  - `source_workbook`, `svod_sheet`, названия причин для аномалий/нормы;
- параметры детекции (`window_minutes`, `shift_minutes`, `min_samples`, `min_duration_minutes`, `gap_minutes`, коэффициенты для расчёта порогов);
- интерпретационные пороги (какой процентный рост трактовать как `↑↑`, `↑` и т.д.);
- `calibration_percentiles` для отчёта `events`;
- секцию `preprocessing` с параметрами Hampel-фильтра и ограничением `forward-fill`;
- секцию `frequency_baseline` (управляет биннингом `Frequency`, списком метрик и минимальным количеством точек для расчёта baseline);
  - `holdout_wells` — скважины, которые не используются при обучении baseline и служат для ручной валидации;
- секцию `detection_residual` с параметрами EWMA/T² (λ, мультипликатор, порог всплеска, уровень значимости, минимальное число точек);
- секцию `alignment` с настройками частоты (`frequency`), агрегатора базового контура (`base_aggregation`) и списка быстрых каналов (`pressure_fast_metrics`);
- пути для экспортов (parquet/json/html).

Любые изменения конфигурации фиксируйте в rollout-заметках задачи.

## 2. Входные данные

`alma/Общая_таблица.xlsx` содержит лист `svod` с указанием:
- скважины;
- причины («Негерметичность НКТ» или «Нормальная работа при изменении частоты»);
- колонок `Время возникновения аномалии`, `Время остановки скважины` (или только начало нормальной работы);
- комментариев с описанием изменения параметров (стрелочки ↑/↓).

Дополнительно в книге есть индивидуальные листы по каждой скважине:
- временные ряды `Intake_Pressure`, `Motor_Temperature`, `Current`, `Frequency`;
- для каждого параметра свои метки времени (`timestamp_*`), частота съёма может отличаться.

## 3. Пересчёт детектора

```bash
python -m src.pipeline anomalies --config config/pipeline.yaml
```

Что происходит:
1. Рабочая книга читается напрямую (без промежуточных parquet).
2. На базовом 15‑минутном контуре применяется предобработка: Hampel-фильтр (окно `preprocessing.hampel_window_minutes`, множитель `preprocessing.hampel_n_sigma`) и ограниченный `forward-fill` пропусков (до `preprocessing.ffill_limit_minutes`).
3. Формируется `DetectionContext`: базовые/быстрые ряды, baseline `Frequency → (median, MAD)`, остаточная модель, список holdout-скважин из `config/pipeline.yaml`.
4. Для тренировочных аномалий выполняется пошаговая симуляция (`evaluate_stepwise_for_intervals`). Пороги `pressure_delta/pressure_slope` пересчитываются по фактическим моментам срабатывания, чтобы обучение и prod-режим совпадали по задержкам.
5. Затем детектор повторно прогоняет все скважины, используя стриминговые пороги и остаточный контроль (`EWMA`, spike, Hotelling `T²`). Повторные срабатывания внутри одного интервала отбрасываются.
6. Срабатывания сортируются, фильтруются по минимальной длительности/gap и сохраняются в parquet/xlsx/json вместе с полями `reference_start`, `reference_delta_minutes`.
7. Экспортируются вспомогательные данные: `timeseries_15min.parquet|csv`, `pressure_fast.parquet|csv`, `frequency_baseline.parquet|csv`.

## 4. Референсная статистика (events)

```bash
python -m src.pipeline events --config config/pipeline.yaml
```

Команда повторно использует те же временные ряды, но агрегирует статистики для каждого интервала из `svod`:
- средние/стандартные отклонения;
- медианы относительных изменений;
- направления `↑↑/↑/=/↓/↓↓`.
Перед расчётами на базовых рядах выполняется та же предобработка (Hampel + ограниченный forward-fill) и частотная нормализация с baseline, что и в шаге детектора.

Результаты:
- `reports/anomalies/events_features.parquet|csv` — построчно по интервалам, включая новые признаки `pressure_min_15m`/`pressure_max_15m`;
- `events_summary.json` — агрегированные значения по классам («normal», «anomaly»).

## 5. Руководство по baseline и аномалиям

Работа с `svod` опирается на следующую схему:

1. **Загрузка строки**
   ```python
   import pandas as pd
   table = pd.read_excel("alma/Общая_таблица.xlsx", sheet_name="svod", header=2)
   rows = table[table["Скв"] == <WELL_ID>]
   ```
2. **Аномальные интервалы** — `Время возникновения аномалии` + `Время остановки скважины` (пустой `end` → использовать конец ряда).
3. **Нормальные интервалы** — если явно задано начало «нормы», конец = конец ряда. При отсутствии — выбираются окна, не попавшие в аномалии.
4. **Параметры** — использовать `Intake_Pressure`, `Current`, `Motor_Temperature`, `Frequency` (либо значения из комментариев).
5. **Статистики** — для каждого окна: `mean`, `std`, `min`, `max`, долю валидных значений, относительные изменения.
6. **Интерпретация** — сопоставить изменения с описанием авторов; зафиксировать отсутствующие сигналы.

## 6. Интерактивные отчёты

```bash
python scripts/generate_reference_report.py --config config/pipeline.yaml
```

Скрипт строит Plotly-графики по всем листам рабочей книги (кроме `svod`) и добавляет HTML-таблицу с пошаговой проверкой:
- исходные ряды по каждому параметру без изменения родной частоты;
- жёлтые прямоугольники и подписи «Начало/Остановка» показывают авторские окна НКТ;
- красные вертикальные метки — моменты срабатывания детектора (старт аномалии);
- таблица «Пошаговая проверка holdout-скважин» берёт актуальный список из конфигурации и показывает задержку между референсом и детекцией (стриминговая симуляция).

Выход: `reports/anomalies/reference_wells_report.html` (флаг `--wells` позволяет ограничить набор графиков). Holdout-таблица обновляется автоматически при изменении `anomalies.holdout_wells`.

## 7. Минимальный чек-лист

1. Рабочая книга `alma/Общая_таблица.xlsx` актуальна, лист `svod` содержит необходимые интервалы.
2. `config/pipeline.yaml` отражает текущие пути и параметры (`anomalies.*`).
3. Пересчитан детектор (`python -m src.pipeline anomalies`), файлы `anomaly_analysis.*` обновлены.
4. (Опционально) Обновлена референсная статистика (`python -m src.pipeline events`), проверены `events_features.*`, `events_summary.json`.
5. Сформирован HTML-отчёт (`scripts/generate_reference_report.py`) для визуальной верификации.
6. Все изменения рабочей книги и конфигурации задокументированы в соответствующей задаче.

Придерживаясь этих шагов, вы получаете консистентный набор интервалов аномалий/нормы по всему фонду скважин.
