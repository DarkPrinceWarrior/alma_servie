# Система детекции негерметичности НКТ на нефтегазовых скважинах

## Задача

Система автоматически обнаруживает аномалии типа **«Негерметичность НКТ»** (насосно-компрессорных труб) по телеметрии работы погружных электронасосов на скважинах. Негерметичность НКТ приводит к снижению эффективности добычи, перегреву оборудования и возможным авариям, поэтому раннее обнаружение критично для эксплуатации фонда скважин.

**Признаки негерметичности:**
- Рост давления на приеме насоса (Intake_Pressure) при неизменной или растущей частоте
- Рост тока двигателя (Current) из-за увеличения нагрузки
- Медленный рост температуры двигателя (Motor_Temperature)
- Характерный профиль изменений во времени (не мгновенный, а плавный)

**Цель системы:**
Автоматически детектировать начало аномалии (момент срабатывания), классифицировать тип события, оценить задержку детекции относительно экспертной разметки.

## Данные

### Структура входных данных

Система работает с Excel-файлом `alma/Общая_таблица.xlsx`, содержащим:

**1. Лист `svod` (сводная таблица экспертной разметки):**
- `Скв` — номер скважины
- `ПричОст` — причина остановки/события:
  - `"Негерметичность НКТ"` — аномалия (целевой класс)
  - `"Нормальная работа при изменении частоты"` — нормальная работа (контрольный класс)
- `Время возникновения аномалии` — начало аномалии по мнению эксперта
- `Время остановки скважины` — конец аномалии (момент остановки насоса или окончания события)
- `Комментарии` — текстовое описание изменений параметров (например, "P↑↑, I↑, T→")

**2. Листы по каждой скважине (например, `1128г`, `5271г`):**

Каждый лист содержит временные ряды с **разной частотой съема** для каждого параметра:

| Параметр | Описание | Типичная частота | Столбцы в Excel |
|----------|----------|------------------|-----------------|
| `Intake_Pressure` | Давление на приеме насоса, атм | 15 минут | `timestamp_Intake_Pressure`, `Intake_Pressure` |
| `Current` | Ток двигателя, А | 15 минут | `timestamp_Current`, `Current` |
| `Motor_Temperature` | Температура двигателя, °C | 15 минут | `timestamp_Motor_Temperature`, `Motor_Temperature` |
| `Frequency` | Частота ПЧ (частотного преобразователя), Гц | 15 минут | `timestamp_Frequency`, `Frequency` |

**Важно:** У каждого параметра свой столбец `timestamp_*`, так как данные могут приходить с разной частотой и иметь разные пропуски.

### Обработка данных

**Шаг 1: Выравнивание временных рядов**

Все параметры приводятся к единой сетке с частотой 15 минут (`config/pipeline.yaml: alignment.frequency = "15T"`):
- Агрегация: по умолчанию `mean` для каждого 15-минутного окна
- Для `Intake_Pressure` дополнительно вычисляются `Intake_Pressure_min` и `Intake_Pressure_max` внутри каждого окна (используются для детекции кратковременных всплесков)
- Временной диапазон: пересечение доступных данных по всем параметрам (общий `[start, end]`)

**Шаг 2: Предобработка (очистка от шума)**

Выполняется функцией `preprocess_well_data()` из модуля `preprocessing.py`:

1. **Hampel-фильтр** (`config: preprocessing.hampel_window_minutes`, `preprocessing.hampel_n_sigma`):
   - Для каждого параметра вычисляется **скользящая медиана** в окне (по умолчанию 45 минут)
   - Вычисляется **MAD** (median absolute deviation): `MAD = median(|x - median(x)|)`
   - Точки, отклоняющиеся более чем на `n_sigma * 1.4826 * MAD` от медианы, заменяются на `NaN`
   - Это удаляет точечные выбросы (сбои датчиков, артефакты связи)

2. **Forward-fill** пропусков (`config: preprocessing.ffill_limit_minutes`):
   - Пропуски в данных заполняются предыдущим значением, но не более чем на 30 минут
   - Это восстанавливает короткие потери связи, не искажая долгосрочные тренды
   - Более длинные пропуски остаются как `NaN`

**Результат предобработки:** Сглаженные временные ряды без точечных выбросов, готовые для вычисления признаков.

## Деление на обучение и тестирование

Система использует **holdout-подход** для валидации:

### Обучающая выборка (training set)

Все скважины **кроме** указанных в `config/pipeline.yaml: anomalies.holdout_wells`.

**Используется для:**
1. Построения **частотного baseline** (зависимость параметров от частоты ПЧ)
2. Расчета **порогов детекции** (квантили распределений признаков)
3. Обучения **остаточной модели** (ковариационная матрица для Hotelling T²)

### Holdout-выборка (test set)

Скважины из списка `anomalies.holdout_wells` (например, `["1128г", "5271г"]`).

**Используется для:**
1. Валидации качества детекции (детектор обучен без этих скважин)
2. Измерения задержки детекции (`reference_delta_minutes`)
3. Построения интерактивных отчетов (`reference_wells_report.html`)

**Важно:** При стриминговой калибровке (`use_streaming_calibration=True`) holdout-скважины обрабатываются **без использования будущих данных** — пороги пересчитываются по мере поступления новых референсных аномалий (имитация продакшн-режима).

## Алгоритм детекции

### 1. Частотная нормализация (Frequency Baseline)

**Проблема:** Нормальные значения параметров зависят от режима работы (частоты ПЧ). При изменении частоты меняются давление, ток, температура даже при исправном оборудовании.

**Решение:** Построение baseline-модели `parameter = f(Frequency)` на нормальных интервалах.

**Алгоритм** (`build_frequency_baseline()` в `detection.py`):

1. Берутся все интервалы с меткой `"Нормальная работа при изменении частоты"` из обучающей выборки
2. Частотный диапазон разбивается на **бины** шириной `bin_width_hz` (по умолчанию 2 Гц):
   - Бин 0: [0, 2) Гц
   - Бин 1: [2, 4) Гц
   - Бин 2: [4, 6) Гц
   - и т.д.
3. Для каждого бина и каждого параметра (`Intake_Pressure`, `Current`, `Motor_Temperature`) вычисляется:
   - `median` — медианное значение параметра в этом частотном диапазоне
   - `MAD` — медианное абсолютное отклонение: `MAD = median(|x - median(x)|) * 1.4826`
   - `count` — количество точек в бине
4. Бины с числом точек меньше `min_points` (по умолчанию 10) отбрасываются

**Применение baseline** (`_apply_frequency_baseline()` в `detection.py`):

Для каждой точки временного ряда:
1. Определяется бин частоты: `bin_index = floor(Frequency / bin_width_hz)`
2. Из baseline берутся `expected = median[bin_index]` и `scale = MAD[bin_index]`
3. Вычисляется **остаток**: `residual = actual - expected`
4. Вычисляется **нормализованный остаток**: `z = residual / scale`

**Для точек с частотой вне обученных бинов:**
- `expected = NaN`
- `scale` берется как медиана всех доступных MAD или fallback = `1.4826 * MAD(исходного ряда)`
- `residual = actual` (используется исходное значение)

**Результат:** Параметры нормализованы относительно режима работы. Остатки (`residual`) отражают отклонения от нормы, не связанные с изменением частоты.

### 2. Вычисление признаков (Features)

Выполняется функцией `compute_feature_frame()` из модуля `detection.py`.

**Базовые признаки для Intake_Pressure:**

1. **Адаптивные параметры окна:**
   - `window_points` — размер окна в точках, соответствующий `window_minutes` (по умолчанию 30 мин)
   - `shift_points` — сдвиг окна в точках, соответствующий `shift_minutes` (по умолчанию 15 мин)
   - `min_periods` — минимум валидных точек для расчета = `(min_samples / window_minutes) * window_points`

2. **pressure_delta** (относительное изменение давления):
   ```
   rolling_pressure = rolling_mean(pressure_residual, window=30min)
   baseline_pressure = rolling_mean(pressure_residual.shift(15min), window=30min)
   pressure_delta = (rolling_pressure - baseline_pressure) / baseline_pressure
   ```
   - Показывает **процентное изменение** давления относительно предыдущего окна
   - Положительное значение = рост давления
   - Типичные значения: норма [-0.02, 0.02], аномалия [0.05, 0.3]

3. **pressure_slope** (скорость роста давления):
   ```
   pressure_slope = pressure_residual - pressure_residual.shift(15min)
   ```
   - Показывает **абсолютный прирост** давления за 15 минут
   - Положительное значение = рост
   - Типичные значения: норма [-0.5, 0.5] атм, аномалия [1, 5] атм

**Аналогичные признаки для Current и Motor_Temperature:**
- `current_delta` — относительное изменение тока
- `temperature_delta` — относительное изменение температуры

**Z-скоры (нормализованные остатки):**

Для каждого параметра:
```
pressure_z = pressure_residual / pressure_scale
current_z = current_residual / current_scale
temperature_z = temperature_residual / temperature_scale
```

Где `*_scale` — это MAD из частотного baseline или fallback-оценка.

**Результат:** DataFrame с признаками для каждой точки времени (индекс = timestamp).

### 3. Определение порогов детекции

Выполняется функцией `derive_thresholds()` из модуля `detection.py`.

**Вход:**
- `normal_features` — признаки всех нормальных интервалов обучающей выборки
- `anomaly_features` — признаки всех аномальных интервалов обучающей выборки
- `settings` — параметры из конфига (`delta_factor`, `slope_margin` и т.д.)

**Алгоритм:**

1. **Для аномалий:**
   ```
   anomaly_delta_threshold = max(
       quantile(|normal_delta|, 0.75) * delta_factor,
       quantile(|anomaly_delta|, 0.8)
   )
   
   anomaly_slope_threshold = max(
       quantile(|normal_slope|, 0.9) + slope_margin,
       quantile(|anomaly_slope|, 0.7)
   )
   ```
   - Порог выбирается так, чтобы покрыть большинство известных аномалий
   - `delta_factor = 0.2` и `slope_margin = 0.03` — зазор для снижения ложных срабатываний

2. **Для нормы:**
   ```
   normal_delta_threshold = quantile(|normal_delta|, 0.95)
   normal_slope_threshold = quantile(|normal_slope|, 0.95)
   ```
   - Используется для фильтрации срабатываний внутри референсных нормальных интервалов

**Результат:**
```python
{
  "anomaly": {
    "pressure_delta": 0.045,
    "pressure_slope": 1.2
  },
  "normal": {
    "pressure_delta": 0.012,
    "pressure_slope": 0.6
  }
}
```

### 4. Остаточная модель детекции

Дополнительный слой контроля на основе мультивариантного анализа. Включается через `config: detection_residual.enabled = true`.

**4.1. Построение модели** (`build_residual_detection_model()` в `detection.py`):

На нормальных интервалах обучающей выборки:
1. Собираются все z-скоры: `[pressure_z, current_z, temperature_z]`
2. Вычисляется **ковариационная матрица** `Σ` (3×3)
3. Вычисляется **обратная матрица** `Σ⁻¹` (для Hotelling T²)
4. Вычисляется **порог T²** по распределению χ² с 3 степенями свободы и уровнем значимости `t2_alpha` (по умолчанию 0.001):
   ```
   T²_threshold = χ²_inv(1 - 0.001, df=3)
   ```

**4.2. Применение модели:**

Для каждой точки времени вычисляются три флага:

1. **EWMA (Exponentially Weighted Moving Average)**:
   ```
   z_t = λ * z_current_t + (1-λ) * z_t-1
   ewma_flag = |z_t| > L * 1.0
   ```
   - `λ = 0.2` (из конфига `ewma_lambda`) — вес текущего наблюдения
   - `L = 3.0` (из конфига `ewma_l_multiplier`) — порог в единицах стандартного отклонения
   - Вычисляется для каждого из трех z-скоров, флаг поднимается если хотя бы один превысил порог
   - **Цель:** обнаружение устойчивых сдвигов (медленных трендов)

2. **Spike Detection** (точечные аномалии):
   ```
   spike_flag = |z_t| > spike_threshold
   ```
   - `spike_threshold = 4.0` (из конфига)
   - Вычисляется для каждого z-скора, флаг если хотя бы один превысил
   - **Цель:** обнаружение резких кратковременных всплесков

3. **Hotelling T²** (мультивариантный контроль):
   ```
   r_t = [pressure_z, current_z, temperature_z]
   T²_t = r_t^T × Σ⁻¹ × r_t
   t2_flag = T²_t > T²_threshold
   ```
   - Учитывает **корреляцию** между параметрами
   - **Цель:** обнаружение комплексных аномалий, когда ни один параметр не сильно отклонился, но их совместное поведение аномально

**Объединенный флаг остаточной детекции:**
```
residual_flag = t2_flag AND spike_flag AND (pressure_slope > anomaly_slope_threshold)
```
- Срабатывает только если одновременно:
  - T² превысил порог (мультивариантная аномалия)
  - Есть spike на каком-то параметре (подтверждение)
  - Давление растет (направление изменения соответствует негерметичности НКТ)

### 5. Детекция сегментов аномалий

Выполняется функцией `detect_segments_for_well()` из модуля `detection.py`.

**Шаг 1: Формирование условий срабатывания**

Основное условие для аномалии:
```python
anomaly_mask = (
    (pressure_delta.abs() >= anomaly_delta_threshold) AND
    (pressure_slope >= anomaly_slope_threshold)
)
```

Если включена остаточная модель:
```python
anomaly_signal = anomaly_mask OR residual_flag
```

**Шаг 2: Фильтрация ложных срабатываний в нормальных интервалах**

Для не-holdout скважин (обучающая выборка):
```python
# Маска референсных нормальных интервалов
reference_normal_mask = [True для точек внутри "Нормальная работа..."]

# Убираем срабатывания внутри нормы
anomaly_signal = anomaly_signal AND NOT reference_normal_mask
```

**Шаг 3: Поиск моментов срабатывания**

Функция `_find_event_times()` ищет **начала** непрерывных интервалов, где `anomaly_signal = True`:
- Срабатывание фиксируется на первом `True` после `False`
- Повторные срабатывания игнорируются, если прошло меньше `gap_minutes` (по умолчанию 10 мин)

**Шаг 4: Привязка к референсным аномалиям**

Для каждого обнаруженного события:
1. Проверяется, попадает ли момент срабатывания внутри референсной аномалии
2. Если нет — ищется **ближайшая неиспользованная** референсная аномалия
3. Если событие произошло **раньше** референсного начала, время корректируется на референсное начало
4. Вычисляется `reference_delta_minutes` — задержка детекции в минутах относительно экспертной метки

**Шаг 5: Формирование записи события**

Для момента срабатывания извлекаются:
- **Признаки:** `pressure_delta`, `pressure_slope`, `current_delta`, `temperature_delta`
- **Исходные параметры:** `pressure_mean`, `current_mean`, `temperature_mean`, `frequency_mean`
- **Min/max давления:** `pressure_min_15m`, `pressure_max_15m` (из 15-минутного окна)
- **Флаги остаточной модели:** `ewma_triggered`, `spike_triggered`, `t2_max`, `residual_triggered`
- **Направления изменений:** классификация через `classify_direction()`:
  ```
  if delta >= 0.1: "↑↑"  (strong_increase)
  elif delta >= 0.03: "↑"  (mild_increase)
  elif delta <= -0.1: "↓↓"  (strong_drop)
  elif delta <= -0.03: "↓"  (mild_drop)
  else: "="  (no change)
  ```
- **Сопоставление с референсом:** `reference_match` (anomaly/normal/none), `reference_start`, `reference_delta_minutes`
- **Пороги:** использованные значения `threshold_pressure_delta`, `threshold_pressure_slope`
- **Score:** `score = pressure_delta * pressure_slope` (для ранжирования событий)

**Шаг 6: Дополнение пропущенных референсных аномалий**

Для не-holdout скважин:
- Если для референсной аномалии не было зафиксировано ни одного срабатывания, создается **дополнительное событие** на момент референсного начала
- Это позволяет отследить случаи, когда детектор не сработал, но аномалия была (false negatives)

**Результат:** Список словарей с полными характеристиками каждого обнаруженного события.

### 6. Стриминговая калибровка (Streaming Calibration)

Выполняется функцией `evaluate_stepwise_for_intervals()` из модуля `simulation.py`.

**Проблема:** При обучении на всех данных сразу пороги рассчитываются с использованием "будущих" аномалий, что невозможно в продакшн-режиме.

**Решение:** Имитация продакшн-режима с пошаговым пересчетом порогов.

**Алгоритм:**

1. Референсные аномалии обучающей выборки сортируются по времени начала
2. Для каждой аномалии по очереди:
   - **Обучение:** Пороги пересчитываются только по аномалиям с `start < текущей аномалии.start`
   - **Детекция:** Алгоритм детекции запускается на данных текущей скважины
   - **Измерение:** Фиксируется задержка между референсным началом и первым срабатыванием
3. Для первых аномалий используются **начальные пороги** из статической калибровки (когда референсов еще недостаточно)

**Результат:** Реалистичная оценка задержки детекции при работе в онлайн-режиме.

**Когда используется:**
- Всегда при запуске `python -m src.pipeline anomalies` (`use_streaming_calibration=True`)
- Финальные пороги в `anomaly_analysis.json` соответствуют продакшн-режиму

## Архитектура проекта

```
alma_servie/
├── config/
│   └── pipeline.yaml           # Конфигурация: пути, параметры детектора, holdout-скважины
├── alma/
│   └── Общая_таблица.xlsx      # Входные данные (НЕ в git)
├── reports/
│   └── anomalies/
│       ├── anomaly_analysis.parquet|xlsx|json  # Результаты детекции
│       ├── timeseries_15min.parquet|csv        # Предобработанные базовые ряды
│       ├── pressure_fast.parquet|csv           # Быстрые ряды давления
│       ├── frequency_baseline.parquet|csv      # Частотная baseline-модель
│       ├── events_features.parquet|csv         # Статистики референсных интервалов
│       ├── events_summary.json                 # Агрегированная статистика
│       └── reference_wells_report.html         # Интерактивный отчет
├── src/pipeline/
│   ├── __main__.py             # Точка входа: python -m src.pipeline <stage>
│   ├── config.py               # Загрузка pipeline.yaml
│   ├── anomalies/              # Модуль детекции аномалий
│   │   ├── __init__.py         # Публичный API, CLI, оркестрация
│   │   ├── models.py           # Dataclass-структуры данных
│   │   ├── settings.py         # Загрузка настроек из конфига
│   │   ├── preprocessing.py    # Hampel-фильтр, forward-fill, загрузка Excel
│   │   ├── detection.py        # Baseline, признаки, пороги, детекция сегментов
│   │   └── simulation.py       # Стриминговая калибровка, пошаговая проверка
│   └── events.py               # Статистики референсных интервалов
├── scripts/
│   └── generate_reference_report.py  # Генерация HTML-отчетов с графиками
├── requirements.txt            # Зависимости
├── README.md                   # Этот файл
└── AGENTS.md                   # Гайдлайны для разработчиков

Модульная структура (src/pipeline/anomalies/):
- models.py      — Структуры данных (ReferenceInterval, DetectionSettings, FrequencyBaseline, ResidualDetectionModel)
- settings.py    — Загрузка конфигурации из YAML в dataclass-ы
- preprocessing.py — Hampel-фильтр, forward-fill, загрузка Excel, формирование WellTimeseries
- detection.py   — Частотный baseline, вычисление признаков, пороги, детекция сегментов, остаточная модель
- simulation.py  — Стриминговая калибровка, пошаговая проверка, DetectionContext
- __init__.py    — Публичный API, CLI, оркестрация всего пайплайна
```

## Установка и запуск

### Требования

- Python 3.12+
- ОС: Linux/Windows/macOS

### Установка зависимостей

```bash
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### Конфигурация

Файл `config/pipeline.yaml` содержит все настройки:

**Пути:**
```yaml
paths:
  reports_dir: reports  # Директория для выходных файлов
```

**Источники данных:**
```yaml
anomalies:
  source_workbook: "./alma/Общая_таблица.xlsx"
  svod_sheet: "svod"
  anomaly_cause: "Негерметичность НКТ"
  normal_cause: "Нормальная работа при изменении частоты"
  holdout_wells:  # Скважины для валидации (не используются при обучении)
    - "1128г"
    - "5271г"
```

**Параметры детекции:**
```yaml
  detection:
    window_minutes: 30      # Размер окна для rolling_mean при вычислении признаков
    shift_minutes: 15       # Сдвиг окна (для baseline в pressure_delta)
    min_samples: 30         # Минимум валидных точек для расчета в окне
    delta_factor: 0.2       # Мультипликатор нормального квантиля для порога delta
    delta_quantile: 0.1     # (не используется в текущей версии)
    slope_margin: 0.03      # Добавка к нормальному квантилю для порога slope
    slope_quantile: 0.15    # (не используется в текущей версии)
    min_duration_minutes: 60  # Минимальная длительность сегмента (для постобработки)
    gap_minutes: 10         # Минимальный промежуток между срабатываниями
```

**Интерпретация направлений:**
```yaml
  interpretation:
    strong_increase: 0.1    # delta >= 0.1 → "↑↑"
    mild_increase: 0.03     # delta >= 0.03 → "↑"
    mild_drop: -0.03        # delta <= -0.03 → "↓"
    strong_drop: -0.1       # delta <= -0.1 → "↓↓"
```

**Предобработка:**
```yaml
  preprocessing:
    hampel_window_minutes: 45  # Размер окна для Hampel-фильтра
    hampel_n_sigma: 3.0        # Порог в стандартных отклонениях (через MAD)
    ffill_limit_minutes: 30    # Максимальное заполнение пропусков forward-fill
```

**Частотный baseline:**
```yaml
  frequency_baseline:
    enabled: true
    bin_width_hz: 2.0        # Ширина частотного бина, Гц
    min_points: 10           # Минимум точек для валидности бина
    metrics:                 # Параметры для нормализации
      - "Intake_Pressure"
      - "Current"
      - "Motor_Temperature"
```

**Остаточная модель:**
```yaml
  detection_residual:
    enabled: true
    ewma_lambda: 0.2           # Вес текущего наблюдения в EWMA
    ewma_l_multiplier: 3.0     # Порог для EWMA-флага
    spike_threshold: 4.0       # Порог для spike-флага (в единицах z-score)
    t2_alpha: 0.001            # Уровень значимости для Hotelling T²
    min_t2_points: 30          # Минимум точек для обучения T²-модели
```

**Выравнивание временных рядов:**
```yaml
alignment:
  frequency: "15T"           # Частота базовой сетки (15 минут)
  base_aggregation: "mean"   # Метод агрегации (mean/median/max/min)
  pressure_fast_metrics:     # Параметры, для которых сохраняются быстрые ряды
    - "Intake_Pressure"
```

### Основные команды

**1. Детекция аномалий:**
```bash
python -m src.pipeline anomalies --config config/pipeline.yaml
```

**Что происходит:**
- Загружается рабочая книга `alma/Общая_таблица.xlsx`
- Выполняется предобработка (Hampel + forward-fill)
- Строится частотный baseline на нормальных интервалах обучающей выборки
- Обучается остаточная модель (ковариационная матрица, T²-порог)
- Вычисляются признаки для всех скважин
- Выполняется стриминговая калибровка порогов
- Детектируются сегменты аномалий
- Результаты сохраняются в `reports/anomalies/`

**Выходные файлы:**
- `anomaly_analysis.parquet|xlsx|json` — обнаруженные аномалии с полными характеристиками
- `timeseries_15min.parquet|csv` — предобработанные временные ряды на 15-минутной сетке
- `pressure_fast.parquet|csv` — быстрые ряды давления (если есть)
- `frequency_baseline.parquet|csv` — таблица частотного baseline (бины, медианы, MAD)

**2. Статистики референсных интервалов:**
```bash
python -m src.pipeline events --config config/pipeline.yaml
```

**Что происходит:**
- Загружаются те же данные и выполняется та же предобработка
- Для каждого интервала из `svod` вычисляются:
  - Средние, стандартные отклонения, медианы параметров
  - Относительные изменения (delta) и направления (↑↑/↑/=/↓/↓↓)
  - `pressure_min_15m`, `pressure_max_15m`
- Результаты сохраняются построчно и агрегированно

**Выходные файлы:**
- `events_features.parquet|csv` — статистики каждого интервала
- `events_summary.json` — агрегированная статистика по классам (normal/anomaly)

**3. Генерация интерактивного отчета:**
```bash
python scripts/generate_reference_report.py --config config/pipeline.yaml
```

**Опции:**
- `--wells 5271г,1123л` — ограничить список скважин

**Что происходит:**
- Для каждой скважины строятся графики всех параметров (на исходной частоте, без ресемплинга)
- Желтыми прямоугольниками отмечаются референсные аномалии из `svod`
- Красными вертикальными линиями — моменты срабатывания детектора
- Формируется таблица **пошаговой проверки holdout-скважин**:
  - Для каждой аномалии показывается задержка детекции (стриминговый режим)
  - Значения признаков в момент срабатывания
  - Триггеры (базовая детекция / остаточная модель)

**Выходной файл:**
- `reports/anomalies/reference_wells_report.html` — открывается в браузере

## Структура выходных данных

### anomaly_analysis.json

```json
{
  "thresholds": {
    "anomaly": {
      "pressure_delta": 0.045,   // Порог для относительного изменения давления
      "pressure_slope": 1.2      // Порог для скорости роста давления
    },
    "normal": {
      "pressure_delta": 0.012,
      "pressure_slope": 0.6
    }
  },
  "training": {
    "anomaly_points": 1523,      // Количество точек в обучающих аномалиях
    "normal_points": 2847,       // Количество точек в обучающей норме
    "anomaly_wells": ["1001", "1002", ...],
    "normal_wells": ["1001", "1003", ...]
  },
  "settings": {
    "window_minutes": 30,
    "shift_minutes": 15,
    ...
  },
  "detections": [
    {
      "well": "1001",
      "start": "2023-05-15T10:30:00",           // Момент срабатывания детектора
      "end": "2023-05-15T10:30:00",             // (пока не используется, равен start)
      "duration_minutes": 0.0,                   // (резерв для будущего)
      "segment_type": "anomaly",
      
      // Признаки в момент срабатывания
      "pressure_delta_median": 0.087,           // Относительное изменение давления
      "pressure_slope_median": 2.4,             // Скорость роста давления (атм/15мин)
      "current_delta_median": 0.034,
      "temperature_delta_median": 0.012,
      
      // Направления изменений
      "pressure_direction": "↑↑",
      "current_direction": "↑",
      "temperature_direction": "=",
      
      // Исходные параметры (средние за 15 минут)
      "pressure_mean": 45.3,                    // атм
      "pressure_min_15m": 44.8,                 // минимум за 15 минут
      "pressure_max_15m": 46.1,                 // максимум за 15 минут
      "current_mean": 67.2,                     // А
      "temperature_mean": 78.5,                 // °C
      "frequency_mean": 48.0,                   // Гц
      
      // Флаги остаточной модели
      "ewma_triggered": true,                   // EWMA-флаг сработал
      "spike_triggered": false,                 // Spike-флаг не сработал
      "t2_max": 18.3,                          // Значение Hotelling T²
      "residual_triggered": false,              // Остаточная модель не сработала
      
      // Сопоставление с экспертной разметкой
      "reference_match": "anomaly",             // Попал в референсную аномалию
      "reference_notes": "P↑↑, I↑, T→",        // Комментарии эксперта
      "reference_start": "2023-05-15T10:15:00", // Начало по мнению эксперта
      "reference_delta_minutes": 15.0,          // Задержка детекции (15 минут)
      
      // Использованные пороги
      "threshold_pressure_delta": 0.045,
      "threshold_pressure_slope": 1.2,
      "threshold_normal_pressure_delta": 0.012,
      "threshold_normal_pressure_slope": 0.6,
      
      // Score для ранжирования
      "score": 0.2088                           // pressure_delta * pressure_slope
    },
    ...
  ]
}
```

### frequency_baseline.csv

```csv
metric,bin_index,frequency_center,count,median,mad
Intake_Pressure,0,1.0,45,35.2,2.1
Intake_Pressure,1,3.0,123,36.8,2.3
Intake_Pressure,2,5.0,287,38.4,2.5
...
Current,0,1.0,45,52.1,3.4
Current,1,3.0,123,54.3,3.6
...
```

**Поля:**
- `metric` — параметр (Intake_Pressure/Current/Motor_Temperature)
- `bin_index` — номер частотного бина
- `frequency_center` — центр бина в Гц
- `count` — количество точек в бине
- `median` — медианное значение параметра в этом режиме
- `mad` — медианное абсолютное отклонение (робастная оценка разброса)

### events_features.csv

```csv
well,interval_start,interval_end,label,pressure_mean,pressure_std,pressure_median_delta,pressure_direction,...
1001,2023-05-15 10:15:00,2023-05-15 14:30:00,anomaly,45.3,2.1,0.087,↑↑,...
```

**Поля:**
- Статистики каждого референсного интервала из `svod`
- `label` — anomaly/normal
- `*_mean`, `*_std` — средние и стандартные отклонения параметров
- `*_median_delta` — медианное относительное изменение
- `*_direction` — классификация направления (↑↑/↑/=/↓/↓↓)
- `pressure_min_15m`, `pressure_max_15m` — экстремумы давления

## Интерпретация результатов

### Оценка качества детекции

**Для holdout-скважин:**
1. Открыть `reports/anomalies/reference_wells_report.html`
2. Найти таблицу "Пошаговая проверка holdout-скважин"
3. Проверить:
   - **delay_minutes** — задержка детекции (должна быть небольшой, 0-30 минут хорошо)
   - **detection_start** — момент срабатывания
   - **reference_start** — момент начала по мнению эксперта
   - **triggers** — что именно сработало (base_detection/residual_model)

**Метрики (вычисляются вручную):**
- **Recall** (полнота): доля обнаруженных референсных аномалий
- **Precision** (точность): доля правильных срабатываний среди всех
- **Средняя задержка**: `mean(reference_delta_minutes)` для обнаруженных
- **False Negatives**: аномалии, для которых `detection_start = None`

### Типичные значения признаков

**Норма (нормальная работа):**
- `pressure_delta`: [-0.02, 0.02]
- `pressure_slope`: [-0.5, 0.5] атм
- `current_delta`: [-0.05, 0.05]
- `temperature_delta`: [-0.03, 0.03]

**Негерметичность НКТ:**
- `pressure_delta`: [0.05, 0.3] (рост 5-30%)
- `pressure_slope`: [1, 5] атм за 15 минут
- `current_delta`: [0.03, 0.15] (рост 3-15%)
- `temperature_delta`: [-0.05, 0.1] (стабильная или медленный рост)
- `pressure_direction`: "↑↑" или "↑"
- `current_direction`: "↑" или "="
- `temperature_direction`: "=" или "↑"

### Анализ ошибок

**False Positives (ложные срабатывания):**
- Проверить `reference_match = "normal"` или `"none"`
- Возможные причины:
  - Резкое изменение частоты вне обученного диапазона
  - Шум в данных (недостаточная предобработка)
  - Плановые операции (перезапуск, переключение режима)
- Решение: добавить эти интервалы в `svod` как "нормальная работа"

**False Negatives (пропущенные аномалии):**
- Проверить аномалии holdout-скважин без `detection_start`
- Возможные причины:
  - Медленное развитие (признаки не превысили порог)
  - Нехватка обучающих примеров похожего типа
  - Пропуски в данных в критический момент
- Решение: снизить пороги (`delta_factor`, `slope_margin`) или добавить аналогичные примеры в обучающую выборку

## Часто задаваемые вопросы

**Q: Почему используется MAD вместо стандартного отклонения?**

A: MAD (median absolute deviation) — робастная оценка разброса, устойчивая к выбросам. Стандартное отклонение сильно завышается из-за единичных аномальных точек, что снижает чувствительность детектора. MAD использует медиану, поэтому до 50% выбросов не влияют на оценку.

**Q: Что такое "стриминговая калибровка" и зачем она нужна?**

A: Это имитация продакшн-режима, когда пороги пересчитываются по мере накопления новых референсных аномалий (без использования "будущих" данных). Без этого пороги рассчитывались бы на всех аномалиях сразу, что давало бы оптимистичную оценку качества (детектор "знал бы будущее"). Стриминговая калибровка дает реалистичную оценку задержки детекции.

**Q: Почему holdout-скважины не используются при обучении?**

A: Это классический подход для валидации — обучаем на одних данных, проверяем на других. Если бы обучались на всех скважинах, детектор мог бы "запомнить" конкретные паттерны holdout-скважин, и мы не могли бы оценить, как он будет работать на новых, ранее не виденных скважинах.

**Q: Как добавить новую скважину в holdout?**

A: Добавить номер скважины в `config/pipeline.yaml: anomalies.holdout_wells`, запустить детекцию заново. Скважина будет исключена из обучения baseline и порогов.

**Q: Что делать, если детектор срабатывает слишком часто?**

A: Увеличить пороги:
- `detection.delta_factor: 0.2 → 0.3` (ужесточить порог для pressure_delta)
- `detection.slope_margin: 0.03 → 0.05` (ужесточить порог для pressure_slope)
Или проверить, не добавлены ли ложные срабатывания в обучающие аномалии (они завышают пороги).

**Q: Что делать, если детектор пропускает аномалии?**

A: Снизить пороги:
- `detection.delta_factor: 0.2 → 0.15`
- `detection.slope_margin: 0.03 → 0.01`
Или добавить больше аналогичных примеров в обучающую выборку (разметить в `svod`).

**Q: Можно ли использовать систему без экспертной разметки?**

A: Нет, система требует **обучения с учителем** — как минимум несколько примеров аномалий и нормы для каждого типа оборудования. Без разметки можно использовать только неконтролируемые методы (например, Isolation Forest), но они дают много ложных срабатываний.

**Q: Какой минимум данных нужен для обучения?**

A: Рекомендуется:
- Минимум 3-5 скважин с аномалиями (всего 5-10 аномалий)
- Минимум 2-3 скважины с нормальной работой
- Покрытие частотного диапазона [30, 60] Гц для построения baseline
- Для holdout — минимум 1-2 скважины

**Q: Как интерпретировать T²-статистику?**

A: Hotelling T² показывает мультивариантное отклонение вектора `[pressure_z, current_z, temperature_z]` от нормального распределения с учетом корреляций. Значения:
- `T² < порог` (обычно ~12-15): норма
- `T² > порог`: аномальное совместное поведение параметров
- Высокие T² без spike могут указывать на медленные системные сдвиги
