# Система обнаружения аномалий в нефтяных скважинах

## Описание проекта
Данный проект реализует автоматизированную систему для обнаружения аномалий в высокочастотных данных датчиков нефтяных скважин. Система нацелена на выявление двух специфических типов отклонений:

1. **Негерметичность (Утечка)**: Внезапные изменения давления на приеме. 
    *   **Алгоритм**: Используется библиотека `Ruptures` (алгоритм PELT, модель l2) для поиска точек изменения среднего.
    *   **Фильтрация**: Отсеиваются ложные срабатывания, связанные с изменением частоты насоса (> 0.5 Гц).
    *   **Валидация**: Проверяется направление изменения давления и тока по правилам из базы знаний (`wells_svod.csv`). Например, если правило "Давление ↑", а по факту оно упало, аномалия отклоняется.

2. **Приток**: Устойчивые постепенные тренды давления.
    *   **Алгоритм**: Скользящая линейная регрессия (окно 24 часа).
    *   **Адаптивный порог**: Для "чистых" трендов ($R^2 > 0.2$) требуется более крутой наклон, чтобы игнорировать медленный дрейф. Для "шумных" данных ($R^2 < 0.2$) принимаются даже слабые изменения, чтобы не пропустить аномалию.
    *   **Проверка на ускорение (Acceleration Check)**: Если обнаружен слабый тренд, алгоритм смотрит на 4 дня вперед. Если там есть тренд в 3 раза сильнее, текущий помечается как "предварительный" (precursor) и игнорируется в пользу более позднего события. Это решает проблему "слишком раннего детектирования".
    *   **Проверка формы (Convexity)**: Отсеиваются временные всплески, которые образуют "арку" (рост, затем падение), требуя линейности или вогнутости тренда.
    *   **Валидация**: Аналогично Негерметичности, проверяются тренды давления, тока и температуры на соответствие правилам.

Система обрабатывает сырые данные датчиков, определяет время начала аномалии, проверяет результаты по эталонным данным (ground truth) и генерирует визуальный HTML-отчет.

## Требования
- Python 3.8 или выше
- pip (установщик пакетов Python)

## Установка

### 1. Клонирование или загрузка репозитория
Перейдите в директорию проекта, где находятся файлы.

### 2. Создание виртуального окружения
Рекомендуется использовать виртуальное окружение для управления зависимостями.

**На macOS и Linux:**
```bash
python3 -m venv venv
source .venv/bin/activate
```

**На Windows (Command Prompt):**
```cmd
python -m venv venv
venv\Scripts\activate
```

**На Windows (PowerShell):**
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
```

### 3. Установка зависимостей
Установите необходимые библиотеки Python, используя файл requirements.txt.

```bash
pip install -r requirements.txt
```

**Ключевые зависимости:**
- `pandas`: Обработка и анализ данных.
- `ruptures`: Алгоритмы обнаружения точек изменения (Change Point Detection).
- `scipy`: Научные вычисления (линейная регрессия).
- `matplotlib`: Визуализация данных.
- `numpy`: Числовые вычисления.

## Структура проекта

- `detect_anomalies.py`: Основной скрипт выполнения. Загружает данные, запускает оба алгоритма обнаружения, сравнивает результаты с эталоном и сохраняет результаты в CSV-файл.
- `generate_static_report.py`: Инструмент отчетности, который читает результаты обнаружения и генерирует автономный HTML-файл со встроенными таблицами и графиками.
- `db/`: Директория, содержащая входные данные (`wells_database.csv`) и эталонные метки (`wells_svod.csv`).
- `requirements.txt`: Список зависимостей проекта.

## Использование

### Шаг 1: Запуск обнаружения аномалий
Запустите основной скрипт обнаружения. Он обработает данные, выведет прогресс в консоль и создаст файл результатов.

```bash
python detect_anomalies.py
```

**Результат:**
- Логи в консоли, показывающие статус обнаружения для каждой скважины.
- `anomaly_detection_results.csv`: Табличная сводка обнаруженных аномалий.

### Шаг 2: Генерация визуального отчета
После завершения обнаружения запустите генератор отчета.

```bash
python generate_static_report.py
```

**Результат:**
- `anomaly_report_static.html`: Полностью автономный файл отчета, содержащий сводную таблицу и встроенные графики для всех проанализированных скважин.

## Интерпретация результатов

Система выводит сравнение между временем обнаруженной аномалии и фактическим временем (из эталонных данных).

- **Status**: Указывает, была ли аномалия "Detected" (Обнаружена) или "Not found" (Не найдена).
- **Логика Негерметичности**: Ищет резкие сдвиги давления (Ruptures), фильтрует по частоте и валидирует направление изменения давления/тока.
- **Логика Притока**: Ищет устойчивые тренды с адаптивным порогом наклона (в зависимости от шума R2) и проверкой на ускорение, чтобы найти момент основного события, а не предвестника.

Для просмотра результатов просто откройте файл `anomaly_report_static.html` в любом современном веб-браузере.
