# Руководство по расчёту baseline и аномалий

Документ описывает, как работать с обновлённой сводной таблицей `alma/Объединенная_таблица.xlsx`, чтобы строить эталонные (baseline) и аномальные статистики по конкретной скважине.

## 1. Исходные данные

- **Сводная таблица**: `alma/Объединенная_таблица.xlsx`, один лист.
  - `Название предупреждения`: тип аномалии.
  - `Дата и время (аномалия)`: интервалы аномального режима.
  - `Общая картина (аномалия)`: общий период для контекстных расчётов (может совпадать с нормой).
  - `Параметр по которому была отмечена аномалия`: список сигналов, по которым нужно считать статистики.
  - `Комментарий (аномалия)`: краткое описание режима.
  - `Дата и время (норма)`: готовый baseline; если отсутствует, используем `Общая картина (норма)` и вычитаем из неё все аномальные интервалы данной скважины.
  - `Комментарий (норма)`: пояснения к baseline (если есть).
- **Почасовые/15‑минутные ряды**: `data/processed/su_resampled.parquet`, `data/processed/agzu_resampled.parquet`.
  - Должны содержать колонку `well_number` с идентификатором скважины (строка).
  - Шаг сетки определяется `config/pipeline.yaml` → `alignment.frequency`.

## 2. Алгоритм для скважины

1. **Загрузка строки**  
   ```python
   import pandas as pd
   table = pd.read_excel("alma/Объединенная_таблица.xlsx")
   rows = table[table["Скважина"] == <ID>]
   ```

2. **Формирование аномальных интервалов**  
   Каждая строка со скважиной даёт диапазон `Дата и время (аномалия)`. Конвертируйте его в `Timestamp` и сохраните список.

3. **Построение baseline**  
   - Если столбец `Дата и время (норма)` заполнен — используйте его.
   - Иначе возьмите `Общая картина (норма)` и последовательно вычтите все аномальные интервалы этой скважины. Итогом будет список базовых отрезков.

4. **Подготовка данных**  
   ```python
   su = pd.read_parquet("data/processed/su_resampled.parquet")
   agzu = pd.read_parquet("data/processed/agzu_resampled.parquet")
   su = su[su["well_number"] == "<ID>"].sort_values("Дата замера")
   agzu = agzu[agzu["well_number"] == "<ID>"].sort_values("Дата окончания замера")
   ```
   > Если скважины нет в parquet — продолжать нечего (нужно прогнать pipeline или уточнить идентификатор).

5. **Выбор параметров**  
   Ориентируйтесь на `Параметр по которому была отмечена аномалия`. Например:
   - SU: `Давление на приеме насоса`, `Выходная частота`, `Ток фазы A`, `Температура двигателя`, `Устьевое давление`.
   - AGZU: `Объемный дебит жидкости, м3/сут`, `Объемный дебит газа, м3/сут`, `Давление в коллекторе ГЗУ при замере`.
   Дополнительные величины из комментариев (например, «загрузка») учитывайте только если доступны в данных.

6. **Агрегация baseline**  
   Объедините все baseline-интервалы:
   ```python
   baseline_su = pd.concat(
       [su[(su["Дата замера"] >= start) & (su["Дата замера"] <= end)] for start, end in baseline_intervals]
   )
   ```
   Аналогично для AGZU.

7. **Агрегация аномалий**  
   Для каждого аномального окна выделите соответствующие строки SU и AGZU.

8. **Расчёт статистик**  
   Для каждой метрики:
   - mean, std, min, max;
   - доля валидных значений (`series.notna().mean()`), доля нулей (если важно отфильтровать отсуствие сигнала);
   - при необходимости — процентное изменение (`(anom_mean - base_mean) / base_mean * 100`).
   Описывайте отдельно baseline и каждое аномальное окно.

9. **Интерпретация**  
   - Сверяйте изменения с типом предупреждения и комментариями.
   - Если сигналы отсутствуют (например, давление всё время `0`) — зафиксируйте это как ограничение.
   - По чистым сигналам (дебиты, ток, частота и т. п.) делайте выводы о характере аномалии.

## 3. Пример (скважина 48361)

1. В таблице один аномальный интервал `15.05.24 09:52 – 20.06.24 10:04`.
2. `Дата и время (норма)` пусто → baseline = `16.03.19 – 16.04.19` минус аномалии = весь март–апрель.
3. В parquet’ах (`su_resampled`, `agzu_resampled`) скважина `48361` присутствует → выгружаем параметры `Давление на приеме насоса`, `Выходная частота`, `Ток фазы A`, `Объемный дебит жидкости, м3/сут`, `Объемный дебит газа, м3/сут`.
4. Статистики показывают:  
   - давление в SU = 0 (сенсор отсутствует), сравнение невозможно;  
   - частота/ток имеют высокую долю нулей → считаем отдельно по валидным;  
   - жидкостный и газовый дебиты падают на ~15% в аномалии при неизменном давлении коллектора → подтверждение «срыва подачи».

## 4. Частые вопросы

- **Скважина отсутствует в parquet**: либо выгрузите данные и повторите pipeline (`extract`, `clean`, `align`), либо уточните идентификатор (иногда вместо `1537Б` используется числовой код).
- **Baseline пересекается с аномалией**: алгоритм выше автоматически «вырезает» пересечения. Если нормальный период полностью покрывается аномалией, baseline → пустой и выводы сделать нельзя.
- **Параметр указан в таблице, но нет в данных**: фиксируйте как ограничение в отчёте; исключение — если показатель хранится в другом источнике (нужно добавить).

Следуя этому чек-листу, можно воспроизводимо готовить baseline/аномальные статистики для любой строки сводной таблицы и использовать их при настройке правил детекции или ручной диагностике.

