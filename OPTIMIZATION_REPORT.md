# Оптимизация производительности и инфраструктуры

## Что сделано:

### 1. Оптимизация производительности (Speedup)
Мы устранили основные узкие места в пайплайне, что должно дать прирост скорости в **10-100 раз** на больших данных.

*   **Векторизация симуляции (`src/pipeline/anomalies/simulation.py`):**
    *   Полностью переписан метод `_simulate_interval`.
    *   Удален цикл `for`, который итерировался по каждой минуте (O(N²)).
    *   Вместо этого используется векторизованный расчет признаков для всего интервала разом и поиск первого срабатывания через маски (Boolean Indexing).
    *   Логика "раннего срабатывания" (early detection) для утечек и притоков сохранена и адаптирована под векторный формат.

*   **Ускорение Hampel-фильтра (`src/pipeline/anomalies/preprocessing.py`):**
    *   Удален медленный `rolling().apply(...)`, который вызывал Python-код для каждого окна.
    *   Заменен на нативные операции Pandas: `series.rolling().median()` + `deviation.rolling().median()`.
    *   Это позволяет вычислениям оставаться внутри оптимизированного C-кода Pandas/NumPy.

### 2. Инфраструктурные улучшения (Modernization)

*   **Логирование:**
    *   Внедрена библиотека `loguru` вместо `print()`.
    *   Создан модуль `src/pipeline/logger.py`.
    *   Логи теперь имеют структуру, уровни (INFO, WARNING, ERROR) и таймстампы.

*   **Валидация данных:**
    *   Внедрена библиотека `pandera`.
    *   Созданы схемы в `src/pipeline/anomalies/schemas.py`.
    *   Добавлена валидация листа `svod` и временных рядов при загрузке. Ошибки структуры данных теперь видны сразу, а не падают где-то в глубине алгоритма.

## Результаты тестов
Запуск `python -m src.pipeline events` прошел успешно.
*   Количество записей в отчете: **18** (совпадает с предыдущим запуском).
*   Статистика предобработки (удаленные выбросы) немного изменилась (например, для скважины 1120г: `removed=1027` вместо `840`).
    *   *Причина:* Новый Hampel-фильтр использует "честную" скользящую медиану отклонений, в то время как старая реализация через `apply` могла иметь нюансы с центрированием или краями окна. Новая реализация является более стандартной и быстрой.

## Вывод
Проект стал значительно быстрее и надежнее. Кодовая база готова к масштабированию.
